generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model D4hAccessKey {
  id        String   @id @default(uuid()) @db.Uuid
  key       String
  enabled   Boolean
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  ownerId   String?  @map("owner_id") @db.Uuid
  teamId    String   @map("team_id") @db.Uuid
  owner     Person?  @relation("d4h_access_key_to_owner", fields: [ownerId], references: [id])
  team      Team     @relation("access_key_to_team", fields: [teamId], references: [id])

  @@map("d4h_access_keys")
}

model HistoryEvent {
  id          String                 @id @default(uuid()) @db.Uuid
  description String
  eventType   HistoryEventType       @map("event_type")
  objectType  HistoryEventObjectType @map("object_type")
  personId    String?                @map("person_id") @db.Uuid
  objectId    String                 @map("object_id") @db.Uuid
  parentId    String?                @map("parent_id") @db.Uuid
  meta        Json
  timestamp   DateTime               @default(now())
  parent      HistoryEvent?          @relation("history_event_to_parent", fields: [parentId], references: [id])
  children    HistoryEvent[]         @relation("history_event_to_parent")

  @@map("history_events")
}

model Person {
  id                           String                   @id @default(uuid()) @db.Uuid
  slug                         String?                  @db.VarChar(100) @unique
  name                         String                   @db.VarChar(100)
  email                        String
  createdAt                    DateTime                 @default(now()) @map("created_at")
  updatedAt                    DateTime                 @updatedAt @map("updated_at")
  status                       RecordStatus             @default(Active)
  clerkUserId                  String?                  @map("clerk_user_id") @db.VarChar(50)
  d4hAccessKeys                D4hAccessKey[]           @relation("d4h_access_key_to_owner")
  skillChecksAsAssessee        SkillCheck[]             @relation("skill_check_to_assessee")
  skillChecksAsAssessor        SkillCheck[]             @relation("skill_check_to_assessor")
  skillCheckSessionsAsAssessee SkillCheckSession[]      @relation("skill_check_session_to_assessee")
  skillCheckSessionsAsAssessor SkillCheckSession[]      @relation("skill_check_session_to_assessor")
  skillPackagePermissions      SkillPackagePermission[] @relation("skill_package_permission_to_person")
  systemPermissions            SystemPermission?        @relation("system_permission_to_person")
  teamMemberships              TeamMembership[]         @relation("team_membership_to_person")
  teamPermissions              TeamPermission[]         @relation("team_permission_to_person")

  @@map("personnel")
}

model Skill {
  id                 String              @id @default(uuid()) @db.Uuid
  slug               String?             @db.VarChar(100) @unique
  packageId          String              @map("package_id") @db.Uuid
  skillGroupId       String?             @map("skill_group_id") @db.Uuid
  name               String
  description        String
  frequency          String
  optional           Boolean
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  status             RecordStatus        @default(Active)
  checks             SkillCheck[]        @relation("skill_check_to_skill")
  package            SkillPackage        @relation("skill_to_skill_package", fields: [packageId], references: [id])
  skillGroup         SkillGroup?         @relation("skill_to_skill_group", fields: [skillGroupId], references: [id])
  skillCheckSessions SkillCheckSession[] @relation("skill_check_session_to_skill")

  @@map("skills")
}

model SkillCheck {
  id              String             @id @default(uuid()) @db.Uuid
  sessionId       String?            @map("session_id") @db.Uuid
  skillId         String             @map("skill_id") @db.Uuid
  assesseeId      String             @map("assessee_id") @db.Uuid
  assessorId      String             @map("assessor_id") @db.Uuid
  competenceLevel CompetenceLevel    @map("competence_level")
  notes           String
  timestamp       DateTime           @default(now())
  session         SkillCheckSession? @relation("skill_check_to_skill_check_session", fields: [sessionId], references: [id])
  assessee        Person             @relation("skill_check_to_assessee", fields: [assesseeId], references: [id])
  assessor        Person             @relation("skill_check_to_assessor", fields: [assessorId], references: [id])
  skill           Skill              @relation("skill_check_to_skill", fields: [skillId], references: [id])

  @@map("skill_checks")
}

model SkillCheckSession {
  id         String                  @id @default(uuid()) @db.Uuid
  assessorId String                  @map("assessor_id") @db.Uuid
  name       String                  @db.VarChar(100)
  date       DateTime
  status     SkillCheckSessionStatus @default(Draft)
  createdAt  DateTime                @default(now()) @map("created_at")
  updatedAt  DateTime                @updatedAt @map("updated_at")
  assessor   Person                  @relation("skill_check_session_to_assessor", fields: [assessorId], references: [id])
  assessees  Person[]                @relation("skill_check_session_to_assessee")
  skills     Skill[]                 @relation("skill_check_session_to_skill")
  checks     SkillCheck[]            @relation("skill_check_to_skill_check_session")
}

model SkillGroup {
  id        String       @id @default(uuid()) @db.Uuid
  slug      String?      @db.VarChar(100) @unique
  name      String       @db.VarChar(100)
  packageId String       @map("package_id") @db.Uuid
  parentId  String?      @map("parent_id") @db.Uuid
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")
  status    RecordStatus @default(Active)
  package   SkillPackage @relation("skill_group_to_skill_package", fields: [packageId], references: [id])
  parent    SkillGroup?  @relation("skill_group_to_parent", fields: [parentId], references: [id])
  children  SkillGroup[] @relation("skill_group_to_parent")
  skills    Skill[]      @relation("skill_to_skill_group")

  @@map("skill_groups")
}

model SkillPackage {
  id          String                   @id @default(uuid()) @db.Uuid
  slug        String?                  @db.VarChar(100) @unique
  name        String                   @db.VarChar(100)
  createdAt   DateTime                 @default(now()) @map("created_at")
  updatedAt   DateTime                 @updatedAt @map("updated_at")
  status      RecordStatus             @default(Active)
  skillGroups SkillGroup[]             @relation("skill_group_to_skill_package")
  skills      Skill[]                  @relation("skill_to_skill_package")
  permissions SkillPackagePermission[] @relation("skill_package_permission_to_skill_package")

  @@map("skill_packages")
}

model SkillPackagePermission {
  id             String       @id @default(uuid()) @db.Uuid
  personId       String       @map("person_id") @db.Uuid
  skillPackageId String       @map("skill_package_id") @db.Uuid
  permissions    String[]
  person         Person       @relation("skill_package_permission_to_person", fields: [personId], references: [id])
  skillPackage   SkillPackage @relation("skill_package_permission_to_skill_package", fields: [skillPackageId], references: [id])

  @@map("skill_package_permissions")
}

model SystemPermission {
    id          String   @id @default(uuid()) @db.Uuid
    personId    String   @map("person_id") @db.Uuid @unique
    permissions String[]
    person      Person   @relation("system_permission_to_person", fields: [personId], references: [id])

    @@map("system_permissions")
}

model Team {
  id              String           @id @default(uuid()) @db.Uuid
  slug            String?          @db.VarChar(100) @unique
  name            String           @db.VarChar(100)
  shortName       String           @db.VarChar(50)
  color           String           @db.VarChar(10)
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  status          RecordStatus     @default(Active)
  d4hTeamId       Int?             @map("d4h_team_id")
  d4hApiUrl       String           @map("d4h_api_url")
  d4hWebUrl       String           @map("d4h_web_url")
  d4hAccessKeys   D4hAccessKey[]   @relation("access_key_to_team")
  teamMemberships TeamMembership[] @relation("team_membership_to_team")
  teamPermissions TeamPermission[] @relation("team_permission_to_team") 

  @@map("teams")
}

model TeamMembership {
  id          String                 @id @default(uuid()) @db.Uuid
  createdAt   DateTime               @default(now()) @map("created_at")
  updatedAt   DateTime               @updatedAt @map("updated_at")
  status      RecordStatus           @default(Active)
  personId    String                 @map("person_id") @db.Uuid
  teamId      String                 @map("team_id") @db.Uuid
  person      Person                 @relation("team_membership_to_person", fields: [personId], references: [id])
  team        Team                   @relation("team_membership_to_team", fields: [teamId], references: [id])
  d4hInfo     TeamMembershipD4hInfo? @relation("team_membership_to_d4h_info")

  @@map("team_memberships")
}

model TeamMembershipD4hInfo {
    id               String               @id @default(uuid()) @db.Uuid
    position         String
    d4hStatus        D4hTeamMemberStatus  @map("d4h_status")
    d4hMemberId      Int                  @map("d4h_member_id")
    d4hRef           String               @map("d4h_ref")
    teamMembershipId String               @map("team_membership_id") @db.Uuid @unique
    teamMembership   TeamMembership       @relation("team_membership_to_d4h_info", fields: [teamMembershipId], references: [id])                  

    @@map("team_memberships_d4h_info")
}

model TeamPermission {
    id          String       @id @default(uuid()) @db.Uuid
    personId    String       @map("person_id") @db.Uuid
    teamId      String       @map("team_id") @db.Uuid
    permissions String[]
    person      Person       @relation("team_permission_to_person", fields: [personId], references: [id])
    team        Team         @relation("team_permission_to_team", fields: [teamId], references: [id])

    @@map("team_permission")
}

enum CompetenceLevel {
    NotAssessed
    NotTaught
    NotCompetent
    Competent
    HighlyConfident
}

enum D4hTeamMemberStatus {
  Operational
  NonOperational
  Observer
  Retired
}

enum HistoryEventObjectType {
  D4hAccessKey
  Person
  Skill
  SkillCheckSession
  SkillGroup
  SkillPackage
  SkillPackagePermission
  Team
  TeamMembership
  TeamPermission
}

enum HistoryEventType {
  Clone
  Create
  Delete
  Import
  Update
}

enum RecordStatus {
  Active
  Inactive
}

enum SkillCheckSessionStatus {
  Draft
  Complete
  Discard
}

