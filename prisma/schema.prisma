// Copyright (c) 2025 Redcloud Development, Ltd.
// Licensed under the MIT License. See LICENSE.md in the project root for license information.
//
// Schema for the rtplus Database.

generator client {
   provider = "prisma-client-js"
}

datasource db {
    provider  = "postgresql"
    url       = env("POSTGRES_PRISMA_URL")
    directUrl = env("POSTGRES_URL_NON_POOLING")
}


model Note {
    noteId       String          @map("note_id") @id @db.VarChar(32)
    orgId        String          @map("org_id") @db.VarChar(50)
    title        String          @db.VarChar(100)
    content      String          @db.Text
    tags         String[]        @default([])
    properties   Json            @default("{}")
    status       NoteStatus      @default(Draft)

    changeLogs   NoteChangeLog[] @relation("note_change_log_to_note")
    organization Organization    @relation("note_to_org", fields: [orgId], references: [orgId], onDelete: Cascade)

    @@map("notes")
}

model NoteChangeLog {
    entryId     String            @map("entry_id") @id @default(cuid())
    noteId      String            @map("note_id") @db.VarChar(16)
    userId      String?           @map("user_id") @db.VarChar(50)
    event       NoteChangeEvent
    meta        Json              @default("{}")
    changes     Json[]            @default([])
    timestamp   DateTime          @default(now())
  
    // Relations
    note        Note              @relation("note_change_log_to_note", fields: [noteId], references: [noteId], onDelete: Cascade)
    user        User?             @relation("note_change_log_to_user", fields: [userId], references: [userId], onDelete: SetNull)

    @@map("notes_change_log")
}

enum NoteChangeEvent {
    Create
    Update
    Delete
}

enum NoteStatus {
    Draft
    Published
    Deleted
}

model Organization {
    orgId        String          @map("org_id") @id @db.VarChar(50) // This is the Clerk organization ID
    name         String          @db.VarChar(100)
    settings     Json            @default("{}")

    // Relations
    personnel          Person[]            @relation("person_to_org")
    teams              Team[]              @relation("team_to_org")
    skillChecks        SkillCheck[]        @relation("skill_check_to_org")
    skillCheckSessions SkillCheckSession[] @relation("skill_check_session_to_org")
    skillPackages      SkillPackage[]      @relation("skill_package_to_owner")
    notes              Note[]              @relation("note_to_org")

    @@map("organizations")
}

/// defines an individual person.
model Person {
    personId                     String                       @map("person_id") @id @db.VarChar(32)
    orgId                        String                       @map("org_id") @db.VarChar(50)
    userId                       String?                      @map("user_id") @db.VarChar(50)
    name                         String                       @db.VarChar(100)
    email                        String                       @db.VarChar(100)
    tags                         String[]                     @default([])
    properties                   Json                         @default("{}")
    status                       RecordStatus                 @default(Active)

    // Relations
    changeLogs                   PersonChangeLog[]            @relation("person_change_log_to_person")
    organization                 Organization                 @relation("person_to_org", fields: [orgId], references: [orgId], onDelete: Cascade)
    skillChecksAsAssessee        SkillCheck[]                 @relation("skill_check_to_assessee")
    skillChecksAsAssessor        SkillCheck[]                 @relation("skill_check_to_assessor")
    skillCheckSessionsAsAssessee SkillCheckSession[]          @relation("skill_check_session_to_assessee")
    skillCheckSessionsAsAssessor SkillCheckSession[]          @relation("skill_check_session_to_assessor")
    teamMemberships              TeamMembership[]             @relation("team_membership_to_person")
    user                         User?                        @relation("person_to_user", fields: [userId], references: [userId], onDelete: SetNull)

    @@unique([orgId, email])
    @@map("personnel")
   
}

enum PersonChangeEvent {
    Create
    Update
    Delete
}

/// defines a change to a person record.
model PersonChangeLog {
    entryId     String            @map("entryId") @id @default(cuid())
    personId    String            @map("person_id") @db.VarChar(32)
    userId      String?           @map("user_id") @db.VarChar(50)
    event       PersonChangeEvent
    description String            @default("")
    meta        Json              @default("{}")
    changes     Json[]            @default([])
    timestamp   DateTime          @default(now())

    // Relations
    person      Person            @relation("person_change_log_to_person", fields: [personId], references: [personId], onDelete: Cascade)
    user        User?             @relation("person_change_log_to_user", fields: [userId], references: [userId], onDelete: SetNull)

    @@map("personnel_change_log")
}


/// defines the current status of a record.
enum RecordStatus {
    Active
    Inactive
}

/// defines an individual skill that can be assessed.
model Skill {
    skillId            String              @map("skillId") @id @db.VarChar(32)
    skillPackageId     String              @map("skill_package_id") @db.VarChar(32)
    skillGroupId       String              @map("skill_group_id") @db.VarChar(32)
    name               String
    description        String
    tags               String[]            @default([])
    properties         Json                @default("{}")
    sequence           Int
    status             RecordStatus        @default(Active)

    // Relations
    checks             SkillCheck[]        @relation("skill_check_to_skill")
    skillPackage       SkillPackage        @relation("skill_to_skill_package", fields: [skillPackageId], references: [skillPackageId], onDelete: Cascade)
    skillGroup         SkillGroup          @relation("skill_to_skill_group", fields: [skillGroupId], references: [skillGroupId], onDelete: Cascade)
    skillCheckSessions SkillCheckSession[] @relation("skill_check_session_to_skill")

    @@map("skills")
}

model SkillCheck {
    skillCheckId    String                    @map("skill_check_id") @id @default(cuid())
    orgId           String                    @map("org_id") @db.VarChar(50)
    sessionId       String?                   @map("session_id") @db.VarChar(32)
    skillId         String                    @map("skill_id") @db.VarChar(32)
    assesseeId      String                    @map("assessee_id") @db.VarChar(32)
    assessorId      String                    @map("assessor_id") @db.VarChar(32)
    passed          Boolean                
    result          String                    @default("")    
    notes           String                    @default("")    
    date            String
    checkStatus     SkillCheckStatus          @default(Draft)
    timestamp       DateTime                  @default(now())

    // Relations
    assessee        Person                    @relation("skill_check_to_assessee", fields: [assesseeId], references: [personId], onDelete: Cascade)
    assessor        Person                    @relation("skill_check_to_assessor", fields: [assessorId], references: [personId], onDelete: Restrict)
    organization    Organization              @relation("skill_check_to_org", fields: [orgId], references: [orgId], onDelete: Cascade)
    session         SkillCheckSession?        @relation("skill_check_to_skill_check_session", fields: [sessionId], references: [sessionId], onDelete: SetNull)
    skill           Skill                     @relation("skill_check_to_skill", fields: [skillId], references: [skillId], onDelete: Cascade)

    @@map("skill_checks")
}

model SkillCheckSession {
    sessionId     String                       @map("session_id") @id @db.VarChar(32)
    orgId         String                       @map("org_id") @db.VarChar(50)
    name          String                       @db.VarChar(100)
    notes         String                       @default("")
    date          String
    sessionStatus SkillCheckSessionStatus      @default(Draft)

    // Relations
    assessors     Person[]                     @relation("skill_check_session_to_assessor")
    assessees     Person[]                     @relation("skill_check_session_to_assessee")
    changeLogs    SkillCheckSessionChangeLog[] @relation("skill_check_session_change_log_to_skill_check_session")
    checks        SkillCheck[]                 @relation("skill_check_to_skill_check_session")
    organization  Organization                 @relation("skill_check_session_to_org", fields: [orgId], references: [orgId], onDelete: Cascade)
    skills        Skill[]                      @relation("skill_check_session_to_skill")
    
    @@map("skill_check_sessions")
}

enum SkillCheckSessionEvent {
    Create
    Update
    Delete
    AddAssessee
    RemoveAssessee
    AddAssessor
    RemoveAssessor
    AddSkill
    RemoveSkill
    CreateCheck
    UpdateCheck
    DeleteCheck
    Complete
    Draft
    Discard
}

model SkillCheckSessionChangeLog {
    entryId        String                  @map("entry_id") @id @default(cuid())
    sessionId      String                  @map("session_id") @db.VarChar(32)
    userId         String?                 @map("user_id") @db.VarChar(50)
    event          SkillCheckSessionEvent
    description    String                  @default("")
    meta           Json                    @default("{}")
    changes        Json[]                  @default([])
    timestamp      DateTime                @default(now())

    // Relations
    session        SkillCheckSession       @relation("skill_check_session_change_log_to_skill_check_session", fields: [sessionId], references: [sessionId], onDelete: Cascade)

    @@map("skill_check_sessions_change_log")
}

enum SkillCheckSessionStatus {
    Draft
    Include
    Exclude
}

enum SkillCheckStatus {
    Draft
    Include
    Exclude
}

/// defines a group of skills within a skill package.
model SkillGroup {
    skillGroupId   String       @map("skill_group_id") @id @db.VarChar(32)
    name           String       @db.VarChar(100)
    description    String       @default("")
    skillPackageId String       @map("skill_package_id") @db.VarChar(32)
    parentId       String?      @map("parent_id") @db.VarChar(32)
    tags           String[]     @default([])
    properties     Json         @default("{}")
    sequence       Int
    status         RecordStatus @default(Active)

    // Relations
    skillPackage   SkillPackage @relation("skill_group_to_skill_package", fields: [skillPackageId], references: [skillPackageId], onDelete: Cascade)
    parent         SkillGroup?  @relation("skill_group_to_parent", fields: [parentId], references: [skillGroupId], onDelete: SetNull)
    children       SkillGroup[] @relation("skill_group_to_parent")
    skills         Skill[]      @relation("skill_to_skill_group")

    @@map("skill_groups")
}

/// defines a package of skills that can be assessed.
model SkillPackage {
    skillPackageId String                  @map("skill_package_id") @id @db.VarChar(32)
    ownerOrgId     String                  @map("owner_org_id") @db.VarChar(50)
    name           String                  @db.VarChar(100)
    description    String                  @default("")
    tags           String[]                @default([])
    properties     Json                    @default("{}")
    sequence       Int
    status         RecordStatus            @default(Active)

    // Relations
    changeLogs  SkillPackageChangeLog[]    @relation("skill_package_change_log_to_skill_package")
    owner       Organization               @relation("skill_package_to_owner", fields: [ownerOrgId], references: [orgId], onDelete: Cascade)
    skillGroups SkillGroup[]               @relation("skill_group_to_skill_package")
    skills      Skill[]                    @relation("skill_to_skill_package")

    @@map("skill_packages")
}

enum SkillPackageChangeEvent {
    Create
    Delete
    Update
    CreateSkill
    DeleteSkill
    UpdateSkill
    CreateGroup
    DeleteGroup
    UpdateGroup
}

// defines a change to a skill package record.
model SkillPackageChangeLog {
    entryId        String                  @map("entry_id") @id @default(cuid())
    skillPackageId String                  @map("skill_package_id") @db.VarChar(32)
    userId         String?                 @map("user_id") @db.VarChar(50)
    event          SkillPackageChangeEvent
    description    String                  @default("")
    meta           Json                    @default("{}")
    changes        Json[]                  @default([])
    timestamp      DateTime                @default(now())

    // Relations
    skillPackage   SkillPackage            @relation("skill_package_change_log_to_skill_package", fields: [skillPackageId], references: [skillPackageId], onDelete: Cascade)
    user           User?                   @relation("skill_package_change_log_to_user", fields: [userId], references: [userId], onDelete: SetNull)

    @@map("skill_packages_change_log")
}


// defines a response team or similar high level organizational unit.
model Team {
    teamId             String              @map("team_id") @id @db.VarChar(32)
    orgId              String              @map("org_id") @db.VarChar(50)
    name               String              @db.VarChar(100)
    color              String              @db.VarChar(10)
    tags               String[]            @default([])
    properties         Json                @default("{}")
    status             RecordStatus        @default(Active)

    // Relations
    d4hInfo            TeamD4hInfo?        @relation("team_d4h_info_to_team")
    changeLogs         TeamChangeLog[]     @relation("team_change_log_to_team")
    organization       Organization        @relation("team_to_org", fields: [orgId], references: [orgId], onDelete: Cascade)
    teamMemberships    TeamMembership[]    @relation("team_membership_to_team")

    @@unique([orgId, name])
    @@map("teams")
}

enum TeamChangeEvent {
    Create
    Delete
    Update
    AddMember
    UpdateMember
    RemoveMember
}

/// defines a change to a team record.
model TeamChangeLog {
    entryId     String          @map("entry_id") @id @default(cuid())
    teamId      String          @map("team_id") @db.VarChar(32)
    userId      String?         @map("user_id") @db.VarChar(50)
    event       TeamChangeEvent
    description String          @default("")
    meta        Json            @default("{}")
    changes     Json[]          @default([])
    timestamp   DateTime        @default(now())

    // Relations
    team        Team            @relation("team_change_log_to_team", fields: [teamId], references: [teamId], onDelete: Cascade)
    user        User?           @relation("team_change_log_to_user", fields: [userId], references: [userId], onDelete: SetNull)

    @@map("teams_change_log")
}

model TeamD4hInfo {
    teamId     String       @map("team_id") @db.VarChar(32) @unique
    d4hTeamId  Int          @map("d4h_team_id")
    serverCode String       @map("server_code")
    status     RecordStatus @default(Active)

    // Relations
    team      Team          @relation("team_d4h_info_to_team", fields:[teamId], references: [teamId], onDelete: Cascade)

    @@map("team_d4h_info")
}

model TeamMembership {
    personId           String                 @map("person_id") @db.VarChar(32)
    teamId             String                 @map("team_id") @db.VarChar(32)
    tags               String[]               @default([])
    properties         Json                   @default("{}")
    status             RecordStatus           @default(Active)
  
    // Relations
    d4hInfo            TeamMembershipD4hInfo? @relation("team_membership_to_d4h_info")
    person             Person                 @relation("team_membership_to_person", fields: [personId], references: [personId], onDelete: Cascade)
    team               Team                   @relation("team_membership_to_team", fields: [teamId], references: [teamId], onDelete: Cascade)

    @@id([personId, teamId])
    @@map("team_memberships")
}

model TeamMembershipD4hInfo {
    personId         String                  @map("person_id") @db.VarChar(32)
    teamId           String                  @map("team_id") @db.VarChar(32)
    position         String
    d4hStatus        TeamMembershipD4hStatus @map("d4h_status")
    d4hMemberId      Int                     @map("d4h_member_id")
    d4hRef           String                  @map("d4h_ref")

    // Relations
    teamMembership   TeamMembership          @relation("team_membership_to_d4h_info", fields: [personId, teamId], references: [personId, teamId], onDelete: Cascade)                  

    @@id([personId, teamId])
    @@map("team_memberships_d4h_info")
}

enum TeamMembershipD4hStatus {
    Operational
    NonOperational
    Observer
    Retired
}

model User {
    userId    String                               @map("user_id") @id @db.VarChar(50) // This is the Clerk user ID
    name      String                               @db.VarChar(100)
    email     String                               @db.VarChar(100)
    settings  Json                                 @default("{}")
    deleted   Boolean                              @default(false)

    // Relations
    noteChangeLogs         NoteChangeLog[]         @relation("note_change_log_to_user")
    personChangeLogs       PersonChangeLog[]       @relation("person_change_log_to_user")
    personnel              Person[]                @relation("person_to_user")
    skillPackageChangeLogs SkillPackageChangeLog[] @relation("skill_package_change_log_to_user")
    teamChangeLogs         TeamChangeLog[]         @relation("team_change_log_to_user")

    @@map("users")
}